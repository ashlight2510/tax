<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Tax Calculator | funnyfunny.cloud</title>
    <meta
      name="description"
      content="Estimate taxes, insurance, and expenses for employees, freelancers, and self-employed individuals. Check your monthly take-home pay and tax payment schedule."
    />

    <!-- OG -->
    <meta property="og:title" content="TAX+CLICK+CALCULATOR" />
    <meta
      property="og:description"
      content="Know+your+real+take-home+in+one+click"
    />
    <meta
      property="og:image"
      content="https://dummyimage.com/1200x630/0b1220/ffffff&text=TAX+CLICK+CALCULATOR"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect width="64" height="64" rx="14" fill="%230b1220"/>
      <path d="M18 22h28v6H18zM18 32h20v6H18zM18 42h28v6H18z" fill="%23ffffff" opacity="0.9"/>
      <circle cx="46" cy="35" r="6" fill="%23ff6b6b"/>
    </svg>'
    />
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1204894220949193" crossorigin="anonymous"></script>
    
    <style>
      :root {
        --bg: #f8f9fa;
        --card: #ffffff;
        --text: #1a1a1a;
        --muted: #6b7280;
        --primary: #0b1220;
        --accent: #3b82f6;
        --accent-hover: #2563eb;
        --line: #e5e7eb;
        --ok: #10b981;
        --warning: #f59e0b;
        --shadow: rgba(0, 0, 0, 0.05);
        --shadow-hover: rgba(0, 0, 0, 0.1);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      .wrap {
        max-width: 860px;
        margin: 0 auto;
        padding: 18px 14px 96px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 14px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .brand-badge {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: var(--primary);
        display: grid;
        place-items: center;
        color: white;
        font-weight: 900;
      }
      .top-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .btn {
        border: 1px solid var(--line);
        background: var(--card);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px var(--shadow);
      }
      .btn:hover {
        box-shadow: 0 2px 4px var(--shadow-hover);
        transform: translateY(-1px);
      }
      .btn.primary {
        border-color: transparent;
        background: var(--accent);
        color: white;
        font-weight: 700;
      }
      .btn.primary:hover {
        background: var(--accent-hover);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      }
      .btn.ghost {
        background: transparent;
        border-color: transparent;
      }
      .btn.ghost:hover {
        background: rgba(0, 0, 0, 0.04);
      }
      .btn:active {
        transform: translateY(0);
      }
      .intro {
        background: linear-gradient(
          180deg,
          #ffffff 0%,
          #ffffff 60%,
          rgba(255, 255, 255, 0) 100%
        );
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 18px;
        margin-bottom: 14px;
      }
      h1 {
        margin: 0 0 12px;
        font-size: 24px;
        line-height: 1.3;
        font-weight: 800;
        color: var(--text);
      }
      .sub {
        margin: 0;
        color: var(--muted);
        font-size: 15px;
        line-height: 1.6;
      }
      .mode-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 14px;
      }
      @media (min-width: 720px) {
        .mode-row {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      .mode {
        border: 2px solid var(--line);
        background: var(--card);
        border-radius: 16px;
        padding: 18px;
        cursor: pointer;
        text-align: left;
        transition: all 0.2s ease;
        min-height: 100px;
        box-shadow: 0 1px 3px var(--shadow);
      }
      .mode:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-hover);
        border-color: var(--accent);
      }
      .mode.active {
        border-color: var(--accent);
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.05) 0%,
          rgba(59, 130, 246, 0.02) 100%
        );
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }
      .mode .t {
        font-weight: 800;
        margin: 0 0 6px;
      }
      .mode .d {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: 1.2fr 0.8fr;
        }
      }
      .panel {
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 1px 3px var(--shadow);
      }
      .panel h2 {
        margin: 0 0 16px;
        font-size: 18px;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text);
      }
      .hint {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
        margin: 0 0 10px;
      }
      .fields {
        display: grid;
        gap: 10px;
      }
      .field {
        display: grid;
        gap: 6px;
      }
      .label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #374151;
        font-weight: 700;
        margin-bottom: 4px;
      }
      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1.5px solid var(--line);
        background: #fff;
        font-size: 14px;
        outline: none;
        transition: all 0.2s ease;
      }
      input:focus,
      select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .row2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .seg {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .seg button {
        border: 1px solid var(--line);
        background: #fff;
        padding: 10px 10px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 750;
        font-size: 13px;
        color: #111;
      }
      .seg button.active {
        background: rgba(11, 18, 32, 0.06);
        border-color: rgba(11, 18, 32, 0.35);
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .note {
        margin-top: 12px;
        padding: 14px 16px;
        background: #f8f9fa;
        border: 1px solid var(--line);
        border-left: 4px solid var(--accent);
        border-radius: 12px;
        color: #374151;
        font-size: 13px;
        line-height: 1.6;
      }
      .result {
        display: none;
        margin-top: 14px;
        border-top: 1px solid var(--line);
        padding-top: 14px;
      }
      .result.show {
        display: block;
      }
      .main-num {
        text-align: center;
        padding: 24px;
        border-radius: 18px;
        border: 2px solid var(--line);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        box-shadow: 0 2px 8px var(--shadow);
      }
      .main-num .k {
        font-size: 14px;
        color: var(--muted);
        font-weight: 700;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .main-num .v {
        font-size: 42px;
        font-weight: 900;
        color: var(--accent);
        margin: 12px 0;
        letter-spacing: -0.5px;
      }
      .main-num .s {
        font-size: 13px;
        color: var(--muted);
        margin-top: 6px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }
      .cards {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      @media (min-width: 720px) {
        .cards {
          grid-template-columns: 1fr 1fr;
        }
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: #fff;
        padding: 18px;
        box-shadow: 0 1px 3px var(--shadow);
        transition: all 0.2s ease;
      }
      .card:hover {
        box-shadow: 0 4px 12px var(--shadow-hover);
      }
      .card .ct {
        margin: 0 0 10px;
        font-weight: 850;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .kv {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        font-size: 14px;
      }
      .kv span {
        color: #374151;
      }
      .kv strong {
        font-weight: 900;
      }
      .bar {
        height: 12px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
        margin: 10px 0 12px;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .bar > div {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent) 0%,
          var(--accent-hover) 100%
        );
        width: 30%;
        transition: width 0.3s ease;
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
      }
      .wave {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 8px;
      }
      .wave li {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 14px;
        padding: 12px 14px;
        border-radius: 12px;
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      .wave li:hover {
        background: #f1f3f5;
        border-color: var(--accent);
      }
      .wave li b {
        font-weight: 900;
      }
      .reserve {
        margin-top: 12px;
        padding: 14px 16px;
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1) 0%,
          rgba(16, 185, 129, 0.05) 100%
        );
        border: 1.5px solid rgba(16, 185, 129, 0.3);
        color: #065f46;
        font-size: 13px;
        line-height: 1.6;
        font-weight: 600;
      }
      .mini {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 16px;
      }
      .mini h3 {
        margin: 0 0 8px;
        font-size: 14px;
      }
      .mini ul {
        margin: 0;
        padding-left: 18px;
        color: #374151;
        font-size: 13px;
        line-height: 1.6;
      }
      .footer-fixed {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(247, 248, 250, 0.86);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--line);
        padding: 10px 12px;
      }
      .footer-fixed .inner {
        max-width: 860px;
        margin: 0 auto;
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .footer-fixed .inner .left {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .tiny {
        font-size: 12px;
        color: var(--muted);
      }
      .tooltip-btn {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #fff;
        color: #555;
        font-size: 12px;
        font-weight: 900;
        cursor: pointer;
        display: inline-grid;
        place-items: center;
        padding: 0;
      }
      .tooltip-btn:hover {
        border-color: rgba(11, 18, 32, 0.35);
      }
      .tip-layer {
        position: absolute;
        z-index: 9999;
        max-width: 280px;
        background: #111;
        color: #fff;
        font-size: 13px;
        line-height: 1.45;
        padding: 10px 12px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
        display: none;
      }
      .tip-layer.show {
        display: block;
      }
      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 76px;
        background: #111;
        color: #fff;
        padding: 10px 12px;
        border-radius: 999px;
        font-size: 13px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease, transform 0.15s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
      }
      .divider {
        height: 1px;
        background: var(--line);
        margin: 10px 0;
      }
      .muted {
        color: var(--muted);
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #fff;
        font-size: 12px;
        color: #374151;
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="brand-badge">FF</div>
          <div>
            <div style="font-weight: 900">Tax Calculator</div>
            <div class="tiny">Employee ¬∑ Freelancer ¬∑ Self-employed</div>
          </div>
        </div>
        <div class="top-actions">
          <button class="btn ghost" id="btnReset">Reset</button>
          <a class="btn ghost" href="./index.html">ÌïúÍµ≠Ïñ¥</a>
          <a
            class="btn"
            href="https://funnyfunny.cloud"
            target="_blank"
            rel="noopener"
            >View Other Services</a
          >
        </div>
      </header>

      <section class="intro">
        <h1>Calculate your taxes easily</h1>
        <p class="sub">
          This is not an exact filing calculation, but an estimation tool to
          understand <b>"your actual take-home pay and tax payment schedule"</b>.<br />
          Enter your information once to see your <b>monthly take-home pay</b> and
          <b>tax payment schedule (months with large payments)</b>.
        </p>

        <div class="mode-row" id="modeRow">
          <button class="mode" data-mode="employee" type="button">
            <p class="t">üëî Employee</p>
            <p class="d">Gross salary ‚Üí Tax+Insurance estimate ‚Üí Net take-home</p>
          </button>
          <button class="mode" data-mode="freelancer" type="button">
            <p class="t">üíª Freelancer/Side Job</p>
            <p class="d">3.3% may be a "preview" rather than the "final" amount</p>
          </button>
          <button class="mode" data-mode="business" type="button">
            <p class="t">üè™ Self-employed</p>
            <p class="d">Prepare for VAT and income tax "big waves"</p>
          </button>
        </div>
      </section>

      <div class="grid">
        <section class="panel" id="inputPanel">
          <h2>
            Input
            <span class="pill" id="modePill">Select Mode</span>
          </h2>
          <p class="hint" id="modeHint">
            Select a mode above to see only the necessary input fields.
          </p>

          <div class="fields" id="fieldsArea"></div>

          <div class="actions">
            <button class="btn primary" id="btnCalc">Calculate</button>
            <button class="btn" id="btnCopySummary">Copy Summary</button>
            <button class="btn" id="btnSave">Save Input</button>
          </div>

          <div class="note" id="disclaimer">
            <b>Important:</b> These results are reference estimates. Actual amounts may vary depending on deductions, industry, documentation, and enrollment type.
            <div class="divider"></div>
            The goal is to get a sense of <b>"how much and why money goes out / when large payments occur"</b> from this single screen.
          </div>

          <div class="result" id="resultSection">
            <div class="main-num">
              <div class="k">
                Monthly Take-home (Estimate)
                <button
                  class="tooltip-btn"
                  data-tooltip="netIncome"
                  type="button"
                >
                  ‚ìò
                </button>
              </div>
              <div class="v">‚Ç©<span id="netAmount">0</span></div>
              <div class="s">
                Estimate ¬∑ May vary by settings
                <button
                  class="tooltip-btn"
                  data-tooltip="estimate"
                  type="button"
                >
                  ‚ìò
                </button>
              </div>
            </div>

            <div class="cards">
              <div class="card">
                <div class="ct">
                  Money Flow
                  <button class="tooltip-btn" data-tooltip="flow" type="button">
                    ‚ìò
                  </button>
                </div>
                <div class="kv">
                  <span>Income</span><strong id="grossAmount">‚Ç©0</strong>
                </div>
                <div class="bar"><div id="outBar"></div></div>
                <div class="kv">
                  <span>Deductions (Tax¬∑Insurance¬∑Expenses)</span
                  ><strong id="outAmount">‚Ç©0</strong>
                </div>
                <div class="divider"></div>
                <div class="tiny muted" id="outBreakdown">-</div>
              </div>

              <div class="card">
                <div class="ct">
                  Tax Wave Forecast
                  <button
                    class="tooltip-btn"
                    data-tooltip="taxWave"
                    type="button"
                  >
                    ‚ìò
                  </button>
                </div>
                <ul class="wave" id="waveList"></ul>
                <div class="reserve" id="reserveBox">
                  It's safe to set aside about <b id="reserveAmount">‚Ç©0</b> per month in a separate "tax account".
                </div>
              </div>
            </div>

            <div
              class="actions"
              style="margin-top: 12px; justify-content: center"
            >
              <button class="btn primary" id="btnRecalc">Recalculate</button>
            </div>
          </div>
        </section>

        <aside class="mini">
          <h3>Beginner's Quick Guide</h3>
          <ul>
            <li>
              <b>3.3%</b>: This may be <b>withheld in advance</b>, not the final tax amount.
            </li>
            <li>
              <b>VAT</b>: You <b>temporarily hold</b> tax collected from customers, then pay it (refunds are possible).
            </li>
            <li>
              <b>Income Tax</b>: Usually settled <b>once a year in a large payment</b>.
            </li>
            <li>
              <b>Key Point</b>: This tool focuses on <b>cash flow + timing</b> rather than accuracy.
            </li>
          </ul>
          <div class="divider"></div>
          <div class="tiny muted">
            Data is saved only in your browser (local). It is not sent to any server.
          </div>
        </aside>
      </div>
    </div>

    <div class="footer-fixed">
      <div class="inner">
        <div class="left">
          <a
            class="btn"
            href="https://funnyfunny.cloud"
            target="_blank"
            rel="noopener"
            >View Other Services</a
          >
          <a class="btn ghost" href="./index.html">ÌïúÍµ≠Ïñ¥</a>
          <span class="tiny">¬© funnyfunny.cloud</span>
        </div>
        <div class="tiny">¬∑ Results are approximate estimates</div>
      </div>
    </div>

    <div
      id="tooltipLayer"
      class="tip-layer"
      role="tooltip"
      aria-hidden="true"
    ></div>
    <div id="toast" class="toast">Copied</div>

    <script>
      // -----------------------------
      // Tooltips
      // -----------------------------
      const TOOLTIPS = {
        netIncome:
          "The amount you can actually use after excluding taxes, insurance, and expenses. Actual results may vary depending on deductions and industry.",
        estimate:
          "Actual payment amounts may differ depending on deduction items, industry, documentation method, enrollment type, etc. Please consult with a tax professional for accurate calculations.",
        flow: "See at a glance how taxes, insurance, and expenses are deducted from total income.",
        taxWave:
          "Business owners and freelancers may have periods when taxes are paid in large amounts. Preparing in advance can reduce the burden.",
      };

      // -----------------------------
      // State
      // -----------------------------
      const state = {
        mode: null, // employee | freelancer | business
        input: {},
        result: {},
      };

      // -----------------------------
      // Helpers
      // -----------------------------
      const $ = (id) => document.getElementById(id);

      function fmt(n) {
        if (!isFinite(n)) return "0";
        return Math.round(n).toLocaleString("en-US");
      }
      function toNumber(val) {
        if (val === null || val === undefined) return 0;
        const s = String(val).replace(/[,\s]/g, "");
        const n = Number(s);
        return isFinite(n) ? n : 0;
      }
      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function toast(msg = "Done") {
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 1500);
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          toast("Copied");
        } catch {
          // fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          toast("Copied");
        }
      }

      // -----------------------------
      // Mode UI
      // -----------------------------
      const modeButtons = Array.from(document.querySelectorAll(".mode"));
      modeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          setMode(mode);
        });
      });

      function setMode(mode) {
        state.mode = mode;
        modeButtons.forEach((b) =>
          b.classList.toggle("active", b.dataset.mode === mode)
        );

        const pill = $("modePill");
        const hint = $("modeHint");
        if (mode === "employee") {
          pill.textContent = "üëî Employee";
          hint.textContent =
            "Simple estimate of tax+4 insurances based on gross monthly salary to show 'net take-home'.";
        } else if (mode === "freelancer") {
          pill.textContent = "üíª Freelancer/Side Job";
          hint.textContent =
            "Based on income/expense ratio, treat 3.3% withholding as 'prepaid money' to show settlement sense.";
        } else if (mode === "business") {
          pill.textContent = "üè™ Self-employed";
          hint.textContent =
            "Estimate net profit from monthly sales/expenses and show preparation for VAT/income tax 'waves'.";
        } else {
          pill.textContent = "Select Mode";
          hint.textContent =
            "Select a mode above to see only the necessary input fields.";
        }

        renderFields();
        $("resultSection").classList.remove("show");
      }

      // -----------------------------
      // Field Renderer
      // -----------------------------
      function fieldText({
        key,
        label,
        placeholder,
        tooltip,
        defaultValue = "",
      }) {
        return `
        <div class="field">
          <div class="label">${label}
            ${
              tooltip
                ? `<button class="tooltip-btn" data-tooltip="${tooltip}" type="button">‚ìò</button>`
                : ""
            }
          </div>
          <input type="text" inputmode="numeric" id="${key}" placeholder="${placeholder}" value="${defaultValue}" />
        </div>
      `;
      }

      function fieldSelect({ key, label, tooltip, options, defaultValue }) {
        const opts = options
          .map(
            (o) =>
              `<option value="${o.value}" ${
                String(o.value) === String(defaultValue) ? "selected" : ""
              }>${o.label}</option>`
          )
          .join("");
        return `
        <div class="field">
          <div class="label">${label}
            ${
              tooltip
                ? `<button class="tooltip-btn" data-tooltip="${tooltip}" type="button">‚ìò</button>`
                : ""
            }
          </div>
          <select id="${key}">${opts}</select>
        </div>
      `;
      }

      function fieldSegment({ key, label, tooltip, items, defaultValue }) {
        const btns = items
          .map(
            (it) => `
        <button type="button" data-k="${key}" data-v="${it.value}" class="${
              String(it.value) === String(defaultValue) ? "active" : ""
            }">
          ${it.label}
        </button>
      `
          )
          .join("");
        return `
        <div class="field">
          <div class="label">${label}
            ${
              tooltip
                ? `<button class="tooltip-btn" data-tooltip="${tooltip}" type="button">‚ìò</button>`
                : ""
            }
          </div>
          <div class="seg" id="${key}__seg">${btns}</div>
        </div>
      `;
      }

      function renderFields() {
        const area = $("fieldsArea");

        // load saved defaults (if any)
        const saved = loadSavedInput();

        let html = "";
        if (!state.mode) {
          area.innerHTML = `<div class="note">Please select a <b>mode</b> from above first.</div>`;
          return;
        }

        if (state.mode === "employee") {
          html += fieldText({
            key: "salary",
            label: "Gross Monthly Salary (‚Ç©)",
            placeholder: "e.g. 3,500,000",
            tooltip: "estimate",
            defaultValue: saved.salary ?? "",
          });
          html +=
            `<div class="row2">` +
            fieldSelect({
              key: "dependents",
              label: "Dependents (Optional)",
              options: [
                { value: 0, label: "0" },
                { value: 1, label: "1" },
                { value: 2, label: "2" },
                { value: 3, label: "3+" },
              ],
              defaultValue: saved.dependents ?? 0,
            }) +
            fieldSelect({
              key: "deductionLevel",
              label: "Year-end Deduction (Optional)",
              tooltip: "estimate",
              options: [
                { value: "low", label: "Almost none" },
                { value: "mid", label: "Average" },
                { value: "high", label: "High" },
              ],
              defaultValue: saved.deductionLevel ?? "mid",
            }) +
            `</div>`;

          html += `<div class="note">
          <b>Employee Point</b><br/>
          What's automatically deducted from monthly salary is mainly <b>income tax (including local tax) + 4 insurances</b>.<br/>
          Year-end settlement is "settled later", so refunds or additional payments may occur.
        </div>`;
        }

        if (state.mode === "freelancer") {
          html += fieldText({
            key: "income",
            label: "Average Monthly Income (‚Ç©)",
            placeholder: "e.g. 4,000,000",
            tooltip: "estimate",
            defaultValue: saved.income ?? "",
          });
          html +=
            `<div class="row2">` +
            fieldSelect({
              key: "expenseRate",
              label: "Expense Ratio (%)",
              tooltip: "flow",
              options: [
                { value: 10, label: "10%" },
                { value: 20, label: "20%" },
                { value: 30, label: "30%" },
                { value: 40, label: "40%" },
                { value: 50, label: "50%" },
                { value: 60, label: "60%" },
                { value: 70, label: "70%" },
              ],
              defaultValue: saved.expenseRate ?? 30,
            }) +
            fieldSegment({
              key: "withholding",
              label: "Is 3.3% withheld?",
              tooltip: "taxWave",
              items: [
                { value: "yes", label: "Yes" },
                { value: "no", label: "No" },
                { value: "unknown", label: "Unknown" },
              ],
              defaultValue: saved.withholding ?? "yes",
            }) +
            `</div>`;

          html += `<div class="note">
          <b>Freelancer Point</b><br/>
          <b>3.3%</b> may not be the final tax but <b>money withheld in advance (withholding tax)</b>.<br/>
          Actual tax is usually settled the following year, and refunds are possible depending on expenses/deductions.
        </div>`;
        }

        if (state.mode === "business") {
          html += fieldText({
            key: "sales",
            label: "Monthly Sales (‚Ç©)",
            placeholder: "e.g. 10,000,000",
            tooltip: "flow",
            defaultValue: saved.sales ?? "",
          });
          html += fieldText({
            key: "cost",
            label: "Monthly Expenses (‚Ç©)",
            placeholder: "e.g. 6,000,000",
            tooltip: "flow",
            defaultValue: saved.cost ?? "",
          });

          html +=
            `<div class="row2">` +
            fieldSegment({
              key: "vatType",
              label: "Industry (VAT)",
              tooltip: "taxWave",
              items: [
                { value: "taxable", label: "Taxable" },
                { value: "exempt", label: "Exempt" },
                { value: "unknown", label: "Unknown" },
              ],
              defaultValue: saved.vatType ?? "taxable",
            }) +
            fieldSegment({
              key: "vatScheme",
              label: "VAT Scheme",
              tooltip: "taxWave",
              items: [
                { value: "general", label: "General" },
                { value: "simple", label: "Simple" },
                { value: "unknown", label: "Unknown" },
              ],
              defaultValue: saved.vatScheme ?? "general",
            }) +
            `</div>`;

          html += `<div class="note">
          <b>Business Owner Point</b><br/>
          VAT is a structure where you <b>temporarily hold</b> tax collected from customers, then pay it (refunds are possible).<br/>
          Income tax usually goes out <b>once a year in a large payment</b>, so a "tax account" is useful.
        </div>`;
        }

        area.innerHTML = html;

        // segment buttons wiring
        area.querySelectorAll(".seg button").forEach((b) => {
          b.addEventListener("click", () => {
            const key = b.dataset.k;
            const seg = $("" + key + "__seg");
            seg
              .querySelectorAll("button")
              .forEach((x) => x.classList.toggle("active", x === b));
          });
        });

        // numeric formatting on input
        area.querySelectorAll('input[type="text"]').forEach((inp) => {
          inp.addEventListener("input", () => {
            const raw = inp.value.replace(/[^\d]/g, "");
            // allow empty
            if (raw.length === 0) {
              inp.value = "";
              return;
            }
            inp.value = Number(raw).toLocaleString("en-US");
          });
        });
      }

      // -----------------------------
      // Input Read
      // -----------------------------
      function readSegment(key) {
        const seg = document.getElementById(key + "__seg");
        if (!seg) return null;
        const active = seg.querySelector("button.active");
        return active ? active.dataset.v : null;
      }

      function readInput() {
        const mode = state.mode;
        const input = {};
        if (mode === "employee") {
          input.salary = toNumber($("salary")?.value);
          input.dependents = Number($("dependents")?.value ?? 0);
          input.deductionLevel = $("deductionLevel")?.value ?? "mid";
        }
        if (mode === "freelancer") {
          input.income = toNumber($("income")?.value);
          input.expenseRate = Number($("expenseRate")?.value ?? 30);
          input.withholding = readSegment("withholding") ?? "unknown";
        }
        if (mode === "business") {
          input.sales = toNumber($("sales")?.value);
          input.cost = toNumber($("cost")?.value);
          input.vatType = readSegment("vatType") ?? "unknown";
          input.vatScheme = readSegment("vatScheme") ?? "unknown";
        }
        state.input = input;
        return input;
      }

      // -----------------------------
      // Approx Tax Model
      // - Not for exact legal/tax rate calculation
      // - Goal is "sense" and "cash flow"
      // -----------------------------
      function employeeModel({ salary, dependents, deductionLevel }) {
        const gross = salary;
        if (gross <= 0) return null;

        // Rough income tax rate by monthly salary brackets (very rough)
        // lower bracket -> smaller rate
        let taxRate;
        const monthly = gross;
        if (monthly < 2500000) taxRate = 0.05;
        else if (monthly < 4000000) taxRate = 0.08;
        else if (monthly < 6000000) taxRate = 0.11;
        else if (monthly < 9000000) taxRate = 0.14;
        else taxRate = 0.17;

        // dependents reduce a bit
        taxRate -= clamp(dependents, 0, 3) * 0.006; // up to -1.8%
        // deduction level tweak
        if (deductionLevel === "low") taxRate += 0.01;
        if (deductionLevel === "high") taxRate -= 0.01;

        taxRate = clamp(taxRate, 0.03, 0.19);

        // 4 insurances (employee share) rough 9% of gross
        // (real differs; used for feel)
        const insuranceRate = 0.09;

        const incomeTax = gross * taxRate;
        const insurance = gross * insuranceRate;

        const out = incomeTax + insurance;
        const net = Math.max(0, gross - out);

        // wave schedule (employee: no big wave, but annual settlement)
        const waves = [
          { month: "Feb~Mar", label: "Year-end settlement (Refund/Additional)", strong: true },
          { month: "Monthly", label: "Income tax¬∑4 insurances auto deduction", strong: false },
        ];

        // reserve suggestion: small buffer for potential additional payment
        const reserve = Math.round(gross * 0.02);

        return {
          gross,
          out,
          net,
          breakdown: {
            "Income tax (incl. local tax, est.)": incomeTax,
            "4 insurances (est.)": insurance,
          },
          waves,
          reserve,
        };
      }

      function freelancerModel({ income, expenseRate, withholding }) {
        const gross = income;
        if (gross <= 0) return null;

        const expRate = clamp(expenseRate / 100, 0, 0.8);
        const expense = gross * expRate;
        const taxableBase = Math.max(0, gross - expense);

        // rough effective tax rate by taxable base (monthly)
        let effRate;
        if (taxableBase < 2000000) effRate = 0.05;
        else if (taxableBase < 3500000) effRate = 0.08;
        else if (taxableBase < 5500000) effRate = 0.11;
        else if (taxableBase < 8000000) effRate = 0.14;
        else effRate = 0.17;

        // predicted annualization impact (rough): push up slightly
        effRate += 0.01;
        effRate = clamp(effRate, 0.05, 0.22);

        const predictedTax = taxableBase * effRate;

        // already withheld
        let prepaid = 0;
        if (withholding === "yes") prepaid = gross * 0.033;
        else if (withholding === "unknown") prepaid = gross * 0.02;

        // monthly net cashflow approximation:
        // user receives gross - prepaid (if any). but we'll show "out" includes expense + predictedTax
        // since expense is "gone money", and predictedTax is "should reserve".
        const out = expense + predictedTax;
        const net = Math.max(0, gross - out);

        const waves = [
          {
            month: "May",
            label: "Income tax settlement (Additional/Refund)",
            strong: true,
          },
          {
            month: "Monthly",
            label: "Expenses + (Withholding/Tax reserve) management",
            strong: false,
          },
        ];

        // reserve suggestion: predictedTax - prepaid (if positive), plus a buffer
        const reserve = Math.round(
          Math.max(0, predictedTax - prepaid) + gross * 0.01
        );

        return {
          gross,
          out,
          net,
          breakdown: {
            "Expenses (est.)": expense,
            "Tax reserve (est.)": predictedTax,
          },
          waves,
          reserve,
          extra: { prepaid },
        };
      }

      function businessModel({ sales, cost, vatType, vatScheme }) {
        const gross = sales;
        if (gross <= 0) return null;

        const expense = Math.max(0, cost);
        const profit = Math.max(0, gross - expense);

        // rough income tax reserve rate for business profit
        let taxReserveRate;
        if (profit < 2000000) taxReserveRate = 0.06;
        else if (profit < 4000000) taxReserveRate = 0.1;
        else if (profit < 7000000) taxReserveRate = 0.14;
        else taxReserveRate = 0.18;
        taxReserveRate = clamp(taxReserveRate, 0.06, 0.25);

        const incomeTaxReserve = profit * taxReserveRate;

        // VAT reserve (only if taxable; simplified)
        // General: net VAT approx (sales - cost) * 10% * 0.4 (assume some deductibility)
        // Simple: smaller/more variable -> use lower reserve factor
        let vatReserve = 0;
        const isTaxable = vatType === "taxable" || vatType === "unknown";
        if (isTaxable) {
          const baseVat = Math.max(0, gross * 0.1);
          if (vatScheme === "general") vatReserve = baseVat * 0.35;
          else if (vatScheme === "simple") vatReserve = baseVat * 0.18;
          else vatReserve = baseVat * 0.25;
        }

        const out = expense + incomeTaxReserve + vatReserve;
        const net = Math.max(0, gross - out);

        const waves = [];
        // VAT wave
        if (isTaxable) {
          waves.push({
            month: "Jan/Jul",
            label: "VAT filing¬∑payment (approx.)",
            strong: true,
          });
        } else {
          waves.push({
            month: "-",
            label: "Exempt industries may have different VAT burden",
            strong: false,
          });
        }
        // Income tax wave
        waves.push({
          month: "May",
          label: "Income tax (big wave)",
          strong: true,
        });
        waves.push({ month: "Nov", label: "Interim payment possibility", strong: false });

        const reserve = Math.round(incomeTaxReserve + vatReserve);

        const breakdown = {
          "Expenses (est.)": expense,
          "Tax reserve (income tax, est.)": incomeTaxReserve,
        };
        if (isTaxable) {
          breakdown["VAT reserve (est.)"] = vatReserve;
        }

        return { gross, out, net, breakdown, waves, reserve };
      }

      function calculate() {
        const input = readInput();

        let res = null;
        if (state.mode === "employee") res = employeeModel(input);
        if (state.mode === "freelancer") res = freelancerModel(input);
        if (state.mode === "business") res = businessModel(input);

        return res;
      }

      // -----------------------------
      // Render Result
      // -----------------------------
      function renderResult(res) {
        state.result = res;

        $("netAmount").textContent = fmt(res.net);
        $("grossAmount").textContent = "‚Ç©" + fmt(res.gross);
        $("outAmount").textContent = "‚Ç©" + fmt(res.out);

        const outPct = res.gross > 0 ? res.out / res.gross : 0;
        $("outBar").style.width =
          (clamp(outPct, 0, 0.95) * 100).toFixed(1) + "%";

        const lines = Object.entries(res.breakdown).map(([k, v]) => {
          return `‚Ä¢ ${k}: ‚Ç©${fmt(v)}`;
        });

        // extra info (freelancer: prepaid)
        if (state.mode === "freelancer" && res.extra?.prepaid) {
          lines.push(
            `‚Ä¢ (Note) Already withheld 3.3% estimate: ‚Ç©${fmt(res.extra.prepaid)}`
          );
        }

        $("outBreakdown").textContent = lines.join("  |  ");

        // waves
        const ul = $("waveList");
        ul.innerHTML = "";
        res.waves.forEach((w) => {
          const li = document.createElement("li");
          li.innerHTML = `<span><b>${w.month}</b></span><span>${w.label}</span>`;
          ul.appendChild(li);
        });

        $("reserveAmount").textContent = "‚Ç©" + fmt(res.reserve);

        $("resultSection").classList.add("show");
        $("resultSection").scrollIntoView({
          behavior: "smooth",
          block: "start",
        });
      }

      // -----------------------------
      // Save/Load (local only)
      // -----------------------------
      const STORAGE_KEY = "ff_tax_click_v1_en";

      function saveInput() {
        if (!state.mode) return;
        const input = readInput();
        const payload = { mode: state.mode, input };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        toast("Saved");
      }

      function loadSavedInput() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return {};
          const obj = JSON.parse(raw);
          // only return input for current mode; if mode not set, return whatever
          if (!obj?.input) return {};
          return obj.input;
        } catch {
          return {};
        }
      }

      function bootFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const obj = JSON.parse(raw);
          if (!obj?.mode) return;
          setMode(obj.mode);

          // fields are rendered; now apply values
          const input = obj.input || {};
          setTimeout(() => {
            if (obj.mode === "employee") {
              if ($("salary"))
                $("salary").value = input.salary
                  ? Number(input.salary).toLocaleString("en-US")
                  : "";
              if ($("dependents"))
                $("dependents").value = String(input.dependents ?? 0);
              if ($("deductionLevel"))
                $("deductionLevel").value = input.deductionLevel ?? "mid";
            }
            if (obj.mode === "freelancer") {
              if ($("income"))
                $("income").value = input.income
                  ? Number(input.income).toLocaleString("en-US")
                  : "";
              if ($("expenseRate"))
                $("expenseRate").value = String(input.expenseRate ?? 30);
              // segment
              const v = input.withholding ?? "yes";
              const seg = $("withholding__seg");
              if (seg) {
                seg
                  .querySelectorAll("button")
                  .forEach((b) =>
                    b.classList.toggle("active", b.dataset.v === v)
                  );
              }
            }
            if (obj.mode === "business") {
              if ($("sales"))
                $("sales").value = input.sales
                  ? Number(input.sales).toLocaleString("en-US")
                  : "";
              if ($("cost"))
                $("cost").value = input.cost
                  ? Number(input.cost).toLocaleString("en-US")
                  : "";
              const vatType = input.vatType ?? "taxable";
              const vatScheme = input.vatScheme ?? "general";
              const segA = $("vatType__seg");
              const segB = $("vatScheme__seg");
              if (segA)
                segA
                  .querySelectorAll("button")
                  .forEach((b) =>
                    b.classList.toggle("active", b.dataset.v === vatType)
                  );
              if (segB)
                segB
                  .querySelectorAll("button")
                  .forEach((b) =>
                    b.classList.toggle("active", b.dataset.v === vatScheme)
                  );
            }
          }, 0);
        } catch {}
      }

      // -----------------------------
      // Buttons
      // -----------------------------
      $("btnCalc").addEventListener("click", () => {
        if (!state.mode) {
          toast("Please select a mode first");
          return;
        }
        const res = calculate();
        if (!res) {
          toast("Please enter required fields");
          return;
        }
        renderResult(res);
      });

      $("btnRecalc").addEventListener("click", () => {
        $("resultSection").classList.remove("show");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      $("btnSave").addEventListener("click", () => {
        if (!state.mode) {
          toast("Please select a mode first");
          return;
        }
        saveInput();
      });

      $("btnCopySummary").addEventListener("click", () => {
        if (!state.mode) {
          copyText("Tax Calculator - Please select a mode and enter information.");
          return;
        }
        const input = readInput();
        const res =
          state.result && isFinite(state.result.net) ? state.result : null;

        const modeName =
          state.mode === "employee"
            ? "Employee"
            : state.mode === "freelancer"
            ? "Freelancer/Side Job"
            : "Self-employed";

        let text = `Tax Calculator (${modeName})\n`;

        if (state.mode === "employee") {
          text += `- Gross monthly salary: ‚Ç©${fmt(input.salary)}\n- Dependents: ${
            input.dependents
          }\n- Deduction: ${input.deductionLevel}\n`;
        }
        if (state.mode === "freelancer") {
          text += `- Monthly income: ‚Ç©${fmt(input.income)}\n- Expense ratio: ${
            input.expenseRate
          }%\n- 3.3%: ${input.withholding}\n`;
        }
        if (state.mode === "business") {
          text += `- Monthly sales: ‚Ç©${fmt(input.sales)}\n- Monthly expenses: ‚Ç©${fmt(
            input.cost
          )}\n- Industry (VAT): ${input.vatType}\n- VAT scheme: ${
            input.vatScheme
          }\n`;
        }

        if (res) {
          text += `\n[Result (Estimate)]\n- Income: ‚Ç©${fmt(
            res.gross
          )}\n- Deductions: ‚Ç©${fmt(res.out)}\n- Take-home: ‚Ç©${fmt(
            res.net
          )}\n- Tax account recommendation: ‚Ç©${fmt(res.reserve)}/month\n`;
        } else {
          text += `\n(Results available after clicking 'Calculate')\n`;
        }

        text += `\nhttps://funnyfunny.cloud`;
        copyText(text);
      });

      $("btnReset").addEventListener("click", () => {
        state.mode = null;
        state.input = {};
        state.result = {};
        modeButtons.forEach((b) => b.classList.remove("active"));
        $("modePill").textContent = "Select Mode";
        $("modeHint").textContent =
          "Select a mode above to see only the necessary input fields.";
        $(
          "fieldsArea"
        ).innerHTML = `<div class="note">Please select a <b>mode</b> from above first.</div>`;
        $("resultSection").classList.remove("show");
        toast("Reset!");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      // -----------------------------
      // Tooltip layer (single instance)
      // -----------------------------
      const tipLayer = $("tooltipLayer");

      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".tooltip-btn");
        if (btn) {
          const key = btn.dataset.tooltip;
          const text = TOOLTIPS[key] || "Description coming soon";
          tipLayer.textContent = text;

          const rect = btn.getBoundingClientRect();
          const left = rect.left + window.scrollX;
          const top = rect.bottom + window.scrollY + 8;

          tipLayer.style.left = left + "px";
          tipLayer.style.top = top + "px";
          tipLayer.classList.add("show");
          tipLayer.setAttribute("aria-hidden", "false");
          return;
        }
        tipLayer.classList.remove("show");
        tipLayer.setAttribute("aria-hidden", "true");
      });

      window.addEventListener("scroll", () => {
        tipLayer.classList.remove("show");
        tipLayer.setAttribute("aria-hidden", "true");
      });

      // -----------------------------
      // Boot
      // -----------------------------
      renderFields();
      bootFromStorage();
    </script>
  
<ins class="adsbygoogle"
     style="display:block; text-align:center"
     data-ad-client="ca-pub-1204894220949193"
     data-ad-slot="5145068706"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

  </body>
</html>
